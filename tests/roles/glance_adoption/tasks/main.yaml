- name: deploy podified Glance with local backend
  ansible.builtin.shell: |
    {{ shell_header }}
    {{ oc_header }}
    oc patch openstackcontrolplane openstack --type=merge --patch-file={{ role_path }}/files/glance_local.yaml
  when: glance_backend == 'local'

- name: deploy podified Glance with Ceph backend
  ansible.builtin.shell: |
    {{ shell_header }}
    {{ oc_header }}
     oc patch openstackcontrolplane openstack --type=merge --patch-file={{ role_path }}/files/glance_ceph.yaml
  when: glance_backend == 'ceph'

- name: deploy podified Glance with Swift backend
  ansible.builtin.shell: |
    {{ shell_header }}
    {{ oc_header }}
    oc patch openstackcontrolplane openstack --type=merge --patch '
    spec:
      glance:
        enabled: true
        template:
          databaseInstance: openstack
          customServiceConfig: |
                [DEFAULT]
                enabled_backends = default_backend:swift
                [glance_store]
                default_backend = default_backend
                [default_backend]
                swift_store_create_container_on_put = True
                swift_store_auth_version = 3
                swift_store_auth_address = {{ .KeystoneInternalURL }}
                swift_store_endpoint_type = internalURL
                swift_store_user = service:glance
                swift_store_key = {{ .ServicePassword }}
          storageClass: "local-storage"
          storageRequest: 10G
          glanceAPIs:
            default:
              replicas: 1
              override:
                service:
                  internal:
                    metadata:
                      annotations:
                        metallb.universe.tf/address-pool: internalapi
                        metallb.universe.tf/allow-shared-ip: internalapi
                        metallb.universe.tf/loadBalancerIPs: 172.17.0.80
                  spec:
                    type: LoadBalancer
              networkAttachments:
              - storage
    '
  when: glance_backend == 'swift'

- name: Check the adopted GlanceAPI
  ansible.builtin.include_tasks: check_glance.yaml
